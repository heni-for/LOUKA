#!/usr/bin/env python3
"""
Enhanced Email Integration for Luca
Supports multiple email providers and fallback options
"""

import os
import webbrowser
import subprocess
from typing import List, Dict, Optional
from datetime import datetime
from .gmail_api import GmailAPI

class EmailIntegration:
    def __init__(self):
        self.outlook_available = self._check_outlook()
        self.gmail_available = self._check_gmail()
        self.gmail_api = GmailAPI()
        
    def _check_outlook(self) -> bool:
        """Check if Outlook is available via COM."""
        try:
            import win32com.client
            outlook = win32com.client.Dispatch('Outlook.Application')
            return True
        except:
            return False
    
    def _check_gmail(self) -> bool:
        """Check if Gmail is accessible via browser."""
        try:
            # Try to open Gmail in default browser
            webbrowser.open('https://mail.google.com')
            return True
        except:
            return False
    
    def get_inbox_summary(self) -> str:
        """Get a summary of recent emails."""
        if self.outlook_available:
            return self._get_outlook_inbox()
        elif self.gmail_available:
            return self._get_gmail_summary()
        else:
            return self._get_email_fallback()
    
    def _get_outlook_inbox(self) -> str:
        """Get Outlook inbox using COM."""
        try:
            import win32com.client
            outlook = win32com.client.Dispatch('Outlook.Application')
            namespace = outlook.GetNamespace("MAPI")
            inbox = namespace.GetDefaultFolder(6)  # 6 = olFolderInbox
            
            messages = inbox.Items
            messages.Sort("[ReceivedTime]", True)  # Sort by received time, descending
            
            recent_emails = []
            for i, message in enumerate(messages):
                if i >= 5:  # Limit to 5 recent emails
                    break
                
                subject = getattr(message, 'Subject', 'No Subject')
                sender = getattr(message, 'SenderName', 'Unknown Sender')
                received_time = getattr(message, 'ReceivedTime', datetime.now())
                
                # Format the time
                if hasattr(received_time, 'strftime'):
                    time_str = received_time.strftime('%H:%M')
                else:
                    time_str = str(received_time)
                
                recent_emails.append(f"‚Ä¢ {subject} - From: {sender} ({time_str})")
            
            if recent_emails:
                return f"üìß Recent emails in your inbox:\n" + "\n".join(recent_emails)
            else:
                return "üìß Your inbox is empty!"
                
        except Exception as e:
            return f"‚ùå Error accessing Outlook: {str(e)}"
    
    def _get_gmail_summary(self) -> str:
        """Provide Gmail access and try to get recent emails."""
        try:
            # Open Gmail
            webbrowser.open('https://mail.google.com')
            
            # Try to get recent emails using Gmail API (if available)
            return """üìß Gmail Integration:
‚Ä¢ Opening Gmail in your browser
‚Ä¢ You can now access your emails directly
‚Ä¢ For voice control, use the web interface
‚Ä¢ Luca can help draft emails if you ask!

üí° To read your last email:
‚Ä¢ Say "read my last email" 
‚Ä¢ Or "read recent emails"
‚Ä¢ I'll help summarize them for you!"""
        except:
            return """üìß Gmail Integration:
‚Ä¢ Opening Gmail in your browser
‚Ä¢ You can now access your emails directly
‚Ä¢ For voice control, use the web interface
‚Ä¢ Luca can help draft emails if you ask!"""
    
    def _get_email_fallback(self) -> str:
        """Fallback when no email client is available."""
        return """üìß Email Integration Options:
‚Ä¢ Install Microsoft Outlook for full integration
‚Ä¢ Use Gmail web interface (opening now)
‚Ä¢ Luca can help draft emails and manage tasks
‚Ä¢ Ask me to 'draft an email' for assistance!"""
    
    def organize_emails(self) -> str:
        """Organize emails (simulated for now)."""
        if self.outlook_available:
            return self._organize_outlook_emails()
        else:
            return """üìÅ Email Organization:
‚Ä¢ Opening your email client for organization
‚Ä¢ Luca can help categorize and prioritize
‚Ä¢ Use voice commands like 'mark as important'
‚Ä¢ Ask me to draft follow-up emails!"""
    
    def _organize_outlook_emails(self) -> str:
        """Organize Outlook emails."""
        try:
            import win32com.client
            outlook = win32com.client.Dispatch('Outlook.Application')
            namespace = outlook.GetNamespace("MAPI")
            inbox = namespace.GetDefaultFolder(6)
            
            messages = inbox.Items
            unread_count = sum(1 for msg in messages if not getattr(msg, 'UnRead', False))
            
            return f"""üìÅ Email Organization Complete:
‚Ä¢ Found {len(messages)} total emails
‚Ä¢ {unread_count} unread emails
‚Ä¢ Emails sorted by date
‚Ä¢ Use 'read' command to access specific emails
‚Ä¢ Ask me to 'draft' replies or follow-ups!"""
            
        except Exception as e:
            return f"‚ùå Error organizing emails: {str(e)}"
    
    def read_email(self, email_id: str = None) -> str:
        """Read a specific email."""
        if self.outlook_available:
            return self._read_outlook_email(email_id)
        else:
            return """üìñ Email Reading:
‚Ä¢ Opening your email client
‚Ä¢ Use the interface to select emails
‚Ä¢ Luca can help summarize emails
‚Ä¢ Ask me to 'draft' responses!"""
    
    def read_last_email(self) -> str:
        """Read the most recent email with AI summary."""
        try:
            # Try Gmail API first
            if self.gmail_api.is_available():
                email = self.gmail_api.get_last_email()
                if email:
                    return self._format_email_with_summary(email)
                else:
                    return "üìß No emails found in your inbox."
            
            # Fallback to browser method
            webbrowser.open('https://mail.google.com')
            
            return """üìñ Reading Your Last Email:
‚Ä¢ Gmail opened in your browser
‚Ä¢ Click on your most recent email
‚Ä¢ Copy the content and paste it here
‚Ä¢ I'll summarize it for you!

üí° Or say "summarize this email" and paste the content
‚Ä¢ I can help draft replies
‚Ä¢ I can extract key information
‚Ä¢ I can suggest follow-up actions"""
            
        except Exception as e:
            return f"‚ùå Error reading email: {str(e)}"
    
    def _format_email_with_summary(self, email: Dict) -> str:
        """Format email with sender and subject only."""
        try:
            # Format the response with just sender and subject
            response = f"""üìß ÿ¢ÿÆÿ± ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä:

üë§ ŸÖŸÜ: {email['sender']}
üìå ÿßŸÑŸÖŸàÿ∂Ÿàÿπ: {email['subject']}

üí° ŸáŸÑ ÿ™ÿ±ŸäÿØ ŸÖŸÜŸä:
‚Ä¢ ŸÇÿ±ÿßÿ°ÿ© ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑŸÉÿßŸÖŸÑÿü
‚Ä¢ ŸÉÿ™ÿßÿ®ÿ© ÿ±ÿØÿü
‚Ä¢ ŸÇÿ±ÿßÿ°ÿ© ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ¢ÿÆÿ±ÿü"""
            
            return response
            
        except Exception as e:
            return f"‚ùå Error formatting email: {str(e)}"
    
    def summarize_email_content(self, email_content: str) -> str:
        """Summarize email content using AI."""
        try:
            from .llm import summarize_email
            
            # Extract subject and body from content
            lines = email_content.split('\n')
            subject = "Email Summary"
            body = email_content
            
            # Look for subject line
            for line in lines:
                if line.lower().startswith('subject:'):
                    subject = line.replace('Subject:', '').strip()
                    break
            
            summary = summarize_email(subject, body)
            
            return f"""üìß Email Summary:
{summary}

üí° Would you like me to:
‚Ä¢ Draft a reply?
‚Ä¢ Extract action items?
‚Ä¢ Categorize this email?"""
            
        except Exception as e:
            return f"‚ùå Error summarizing email: {str(e)}"
    
    def _read_outlook_email(self, email_id: str) -> str:
        """Read specific Outlook email."""
        try:
            import win32com.client
            outlook = win32com.client.Dispatch('Outlook.Application')
            namespace = outlook.GetNamespace("MAPI")
            inbox = namespace.GetDefaultFolder(6)
            
            if email_id:
                # Try to find email by ID
                try:
                    message = inbox.Items[email_id]
                except:
                    return f"‚ùå Email with ID {email_id} not found"
            else:
                # Get the most recent email
                messages = inbox.Items
                messages.Sort("[ReceivedTime]", True)
                message = messages[0]
            
            subject = getattr(message, 'Subject', 'No Subject')
            sender = getattr(message, 'SenderName', 'Unknown Sender')
            body = getattr(message, 'Body', 'No content')
            
            return f"""üìñ Email Details:
Subject: {subject}
From: {sender}
Content: {body[:200]}{'...' if len(body) > 200 else ''}

Ask me to 'draft a reply' or 'summarize this email'!"""
            
        except Exception as e:
            return f"‚ùå Error reading email: {str(e)}"
    
    def draft_email(self, prompt: str) -> str:
        """Draft an email using AI."""
        try:
            from .llm import draft_email
            draft = draft_email(prompt)
            
            # Try to open email client
            if self.outlook_available:
                self._open_outlook_draft(draft)
                return f"""‚úçÔ∏è Email Drafted:
{draft}

Opening Outlook to send..."""
            else:
                # Copy to clipboard as fallback
                try:
                    import pyperclip
                    pyperclip.copy(draft)
                    return f"""‚úçÔ∏è Email Drafted (copied to clipboard):
{draft}

Paste this into your email client!"""
                except:
                    return f"""‚úçÔ∏è Email Drafted:
{draft}

Copy this text into your email client!"""
                    
        except Exception as e:
            return f"‚ùå Error drafting email: {str(e)}"
    
    def _open_outlook_draft(self, draft: str):
        """Open Outlook with the draft."""
        try:
            import win32com.client
            outlook = win32com.client.Dispatch('Outlook.Application')
            mail = outlook.CreateItem(0)  # 0 = olMailItem
            mail.Body = draft
            mail.Display()
        except:
            pass
    
    def get_status(self) -> str:
        """Get email integration status."""
        status = []
        if self.outlook_available:
            status.append("‚úÖ Outlook COM integration")
        if self.gmail_available:
            status.append("‚úÖ Gmail web access")
        if self.gmail_api.is_available():
            status.append("‚úÖ Gmail API integration (automatic reading)")
        else:
            status.append("‚ö†Ô∏è Gmail API not configured")
            status.append("üí° Run 'python setup_gmail_api.py' for automatic email reading")
        
        if not status:
            status.append("‚ö†Ô∏è No email client detected")
            status.append("üí° Install Outlook or configure Gmail API")
        
        return "üìß Email Integration Status:\n" + "\n".join(status)
